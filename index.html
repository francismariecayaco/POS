<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POS Inventory System</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  // Disable right-click, F12, inspect, view-source
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.onkeydown = function (e) {
    if (
      e.key === 'F12' ||
      (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) ||
      (e.ctrlKey && e.key === 'U')
    ) {
      return false;
    }
  };
</script>
</head>
<body class="bg-gray-50">

<!-- Login Panel -->
<div id="loginPanel" class="min-h-screen flex items-center justify-center">
  <div class="bg-white shadow rounded p-8 w-full max-w-md">
    <h2 class="text-2xl font-bold text-center mb-4">Login</h2>
    <form id="loginForm" class="space-y-4">
      <input type="email" id="loginEmail" placeholder="Email" class="w-full border p-2 rounded" required />
      <input type="password" id="loginPassword" placeholder="Password" class="w-full border p-2 rounded" required />
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Login</button>
      <div class="text-center">
        <a href="#" id="resetLink" class="text-sm text-blue-600 underline">Forgot Password?</a>
      </div>
    </form>
  </div>
</div>



<!-- Main Dashboard -->
<div id="dashboard" class="hidden">
  <nav class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-blue-700">Dashboard</h1>
    <div>
      <span id="userEmail" class="text-gray-600 mr-4"></span>
      <button onclick="logout()" class="text-red-600 font-semibold">Logout</button>
    </div>
  </nav>
  <div id="roleTabs" class="p-4 space-x-2"></div>
  <div id="roleContent" class="p-4"></div>
</div>

<!-- POS Panel (used for both Add and Sell, but only one visible at a time) -->
<div id="posPanel" class="hidden p-4">
  <!-- Add Product Form -->
  <div id="addProductPanel" class="max-w-xl mx-auto bg-white p-4 rounded shadow hidden">
    <h2 class="text-lg font-bold mb-4 text-blue-700">Add Product</h2>
    <form id="productForm" class="space-y-4">
      <input type="text" id="productName" placeholder="Product Name" class="w-full border p-2 rounded" required />
      <select id="productType" class="w-full border p-2 rounded" required>
        <option value="wet">Wet Goods</option>
        <option value="dry">Dry Goods</option>
        <option value="appliance">Appliances</option>
      </select>
      <input type="number" id="productQty" placeholder="Quantity" class="w-full border p-2 rounded" required />
      <input type="number" id="productPrice" placeholder="Price" class="w-full border p-2 rounded" required readonly />
      <input type="date" id="productDate" class="w-full border p-2 rounded" required />
      <input type="file" id="productPhoto" accept="image/*" class="w-full border p-2 rounded" />
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Add Product</button>
    </form>
    <div id="qrcode" class="mt-6 flex justify-center"></div>
    <table id="productTable" class="w-full mt-6 table-auto bg-gray-50 rounded shadow text-sm">
      <thead>
        <tr>
          <th class="p-2">Name</th>
          <th class="p-2">Type</th>
          <th class="p-2">Qty</th>
          <th class="p-2">Price</th>
          <th class="p-2">Date</th>
          <th class="p-2">Status</th>
          <th class='p-2'>QR Code</th>
        </tr>
      </thead>
      <tbody>
        <!-- Products will be loaded here -->
      </tbody>
    </table>
  </div>
  <!-- Sell Product Panel -->
  <div id="sellProductPanel" class="hidden">
    <h2 class="text-lg font-bold mb-4 text-green-700">Sell Product</h2>
    <div id="sellProductList"></div>
  </div>
  <!-- Bundle Sell Panel -->
  <div id="bundleSellPanel" class="hidden">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-bold text-pink-700">Bundle Sell</h2>
      <button id="closeBundleSellPanel" class="text-2xl text-gray-500 hover:text-red-600">&times;</button>
    </div>
    <form id="bundleSellForm" class="space-y-4"></form>
  </div>
</div>

<!-- Super Admin Inventory View -->
<div id="superadminPanel" class="hidden p-4">
  <h2 class="text-lg font-bold mb-4">All Inventory (All Branches)</h2>
  <div class="flex gap-4 mb-4">
    <input type="text" id="filterBranch" placeholder="Filter by Branch..." class="border p-2 rounded w-1/2" />
    <select id="filterType" class="border p-2 rounded w-1/2">
      <option value="">All Types</option>
      <option value="wet">Wet Goods</option>
      <option value="dry">Dry Goods</option>
      <option value="appliance">Appliances</option>
    </select>
    <button id="exportCsvBtn" class="ml-auto px-4 py-2 bg-green-600 text-white rounded">Export CSV</button>
  </div>
  <canvas id="topProductsChart" class="w-full max-w-3xl mx-auto mb-8"></canvas>
  <div class="text-right font-semibold text-gray-700 mb-2" id="totalValuation"></div>
  <table class="w-full bg-white rounded shadow table-auto text-left">
    <thead class="bg-gray-100 text-sm">
      <tr>
        <th class="p-2">Name</th>
        <th class="p-2">Type</th>
        <th class="p-2">Qty</th>
        <th class="p-2">Price</th>
        <th class="p-2">Date</th>
        <th class="p-2">Added By</th>
        <th class="p-2">Alert</th>
      </tr>
    </thead>
    <tbody id="superadminTable"></tbody>
  </table>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded shadow-lg p-6 w-full max-w-2xl relative">
    <button id="closeProfileModal" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl">&times;</button>
    <h2 class="text-lg font-bold mb-4">My Profile</h2>
    <form id="profileForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <input type="text" id="profileFirstName" placeholder="First Name" class="border p-2 rounded" required />
        <input type="text" id="profileMiddleName" placeholder="Middle Name" class="border p-2 rounded" />
        <input type="text" id="profileLastName" placeholder="Last Name" class="border p-2 rounded" required />
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input type="date" id="profileBirthday" placeholder="Birthday" class="border p-2 rounded" required />
        <input type="text" id="profileMobile" placeholder="Mobile Number" class="border p-2" />
      </div>
      <div>
        <textarea id="profileAddress" placeholder="Address" class="border p-2 rounded w-full" rows="3" required></textarea>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <select id="profileGender" class="border p-2 rounded" required>
          <option value="">Gender</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
        <select id="profileMaritalStatus" class="border p-2 rounded" required>
          <option value="">Marital Status</option>
          <option>Single</option>
          <option>Married</option>
          <option>Divorced</option>
          <option>Widowed</option>
        </select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input type="email" id="profileEmail" placeholder="Email Address" class="border p-2 rounded" required />
        <input type="text" id="profileFacebook" placeholder="Facebook Account" class="border p-2 rounded" />
        <input type="text" id="profileInstagram" placeholder="Instagram Account" class="border p-2 rounded" />
        <input type="text" id="profileViber" placeholder="Viber Account" class="border p-2 rounded" />
        <input type="text" id="profileWhatsApp" placeholder="WhatsApp Account" class="border p-2 rounded" />
        <input type="text" id="profileTikTok" placeholder="TikTok Account" class="border p-2 rounded" />
        <input type="text" id="profileTelegram" placeholder="Telegram Account" class="border p-2 rounded" />
        <input type="text" id="profileBranch" placeholder="Store / Branch Designated" class="border p-2 rounded" required />
      </div>
      <!-- Add Company, Position, Department fields -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <input type="text" id="profileCompany" placeholder="Company" class="border p-2 rounded" readonly />
        <input type="text" id="profilePosition" placeholder="Position" class="border p-2 rounded" readonly />
        <input type="text" id="profileDepartment" placeholder="Department" class="border p-2 rounded" readonly />
      </div>
      <input type="password" id="profilePassword" placeholder="New Password (leave blank to keep current)" class="border p-2 rounded w-full" />
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Save</button>
    </form>
  </div>
</div>

<!-- Add User/Admin Modal -->
<div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded shadow-lg p-6 w-full max-w-md relative">
    <button id="closeAddUserModal" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl">&times;</button>
    <h2 class="text-lg font-bold mb-4" id="addUserModalTitle">Add User</h2>
    <form id="addUserForm" class="space-y-4">
      <input type="email" id="modalUserEmail" placeholder="Email" class="w-full border p-2 rounded" required />
      <input type="password" id="modalUserPassword" placeholder="Password" class="w-full border p-2 rounded" required />
      <select id="modalUserRole" class="w-full border p-2 rounded">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Add</button>
    </form>
  </div>
</div>

<!-- Firebase Config + Script Merged in Next Update -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, getDoc, updateDoc, setDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js';
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js';

const firebaseConfig = {
  apiKey: 'AIzaSyCoNNaQ30xVM3tjC1vBiUp6y8Hkl8sy2V8',
  authDomain: 'maynilatekdo.firebaseapp.com',
  databaseURL: 'https://maynilatekdo-default-rtdb.asia-southeast1.firebasedatabase.app',
  projectId: 'maynilatekdo',
  storageBucket: 'maynilatekdo.appspot.com',
  messagingSenderId: '835673306092',
  appId: '1:835673306092:web:f0541edb14edc7741b46c9',
  measurementId: 'G-B1S4DB0T5G'
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const loginPanel = document.getElementById('loginPanel');
const dashboard = document.getElementById('dashboard');
const userEmail = document.getElementById('userEmail');
const roleTabs = document.getElementById('roleTabs');
const roleContent = document.getElementById('roleContent');

let role = null;

// --- Helper to hide all panels before showing the correct one ---
function hideAllPanels() {
  document.getElementById('posPanel').classList.add('hidden');
  document.getElementById('superadminPanel').classList.add('hidden');
  // You can add more panels here if needed
}

// --- Update onAuthStateChanged to hide all panels before showing dashboard ---
onAuthStateChanged(auth, async (user) => {
  if (user) {
    await addDoc(collection(db, 'attendance'), {
      uid: user.uid,
      email: user.email,
      timestamp: Timestamp.now(),
      action: 'Logged in'
    });
    const userDoc = await getDoc(doc(db, 'users', user.uid));
    if (userDoc.exists()) {
      // Hide all panels before showing dashboard
      hideAllPanels();
      // Show dashboard
      const data = userDoc.data();
      role = data.role;
      const adminCompany = data.company || '';
      loginPanel.classList.add('hidden');
      dashboard.classList.remove('hidden');
      userEmail.textContent = `${user.email} (${role})`;
      roleTabs.innerHTML = ''; // Clear previous tabs
      roleContent.innerHTML = ''; // Clear previous content
      if (role === 'user') {
        loadEndUserTabs();
        document.getElementById('posPanel').classList.remove('hidden');
        loadUserProducts();
      }
      else if (role === 'admin') {
        await loadAdminTabs();
        // Hide panels by default for admin
      }
      else if (role === 'superadmin') {
        loadSuperadminTabs();
        document.getElementById('superadminPanel').classList.remove('hidden');
        roleContent.innerHTML = '';
        loadSuperAdminProducts();
      }
    } else {
      alert('No user profile found in Firestore. Please contact admin.');
      await signOut(auth);
    }
  } else {
    // Not logged in, show login panel
    loginPanel.classList.remove('hidden');
    dashboard.classList.add('hidden');
    hideAllPanels();
  }
});

document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = loginEmail.value;
  const password = loginPassword.value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (err) {
    alert('Login failed: ' + err.message);
  }
});

document.getElementById('resetLink').addEventListener('click', async (e) => {
  e.preventDefault();
  const email = prompt("Enter your email:");
  if (email) await sendPasswordResetEmail(auth, email);
});

window.logout = () => {
  alert('You have been logged out.');
  signOut(auth);
};

// POS Submission
const form = document.getElementById('productForm');
const qrDisplay = document.getElementById('qrcode');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  let photoURL = '';
  const file = document.getElementById('productPhoto').files[0];
  if (file) {
    const imgRef = storageRef(storage, 'product_photos/' + Date.now() + '_' + file.name);
    await uploadBytes(imgRef, file);
    photoURL = await getDownloadURL(imgRef);
  }
  // Fetch the user's company from their profile
  const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
  const userData = userDoc.data();
  const company = userData.company || '';

  const product = {
    name: productName.value,
    type: productType.value,
    qty: +productQty.value,
    price: +productPrice.value,
    productDate: productDate.value, // fallback
    createdAt: Timestamp.now(),
    addedBy: auth.currentUser.uid,
    company: company,
    approved: false,
    photo: photoURL
  };

  // Set the correct date field
  if (product.type === 'wet') product.receivedDate = productDate.value;
  if (product.type === 'dry') product.expirationDate = productDate.value;
  if (product.type === 'appliance') product.manufacturingDate = productDate.value;

  const ref = await addDoc(collection(db, 'products'), product);
  QRCode.toCanvas(document.createElement('canvas'), JSON.stringify(product), (err, canvas) => {
    if (!err) qrDisplay.innerHTML = '', qrDisplay.appendChild(canvas);
  });
  form.reset();
  loadUserProducts();
});

// Add these variables at the top of your script
let inventoryCurrentPage = 1;
const inventoryPageSize = 10;
let inventoryData = [];

// Add filter and pagination controls in your HTML, e.g. above the table
// <input type="text" id="inventoryFilter" placeholder="Filter by name..." class="border p-2 rounded mb-2" />
// <div id="inventoryPagination" class="mt-2"></div>

// Update loadUserProducts to support filter and pagination
async function loadUserProducts() {
  const q = query(collection(db, 'products'), where('addedBy', '==', auth.currentUser.uid));
  const snap = await getDocs(q);
  inventoryData = [];
  snap.forEach(doc => {
    const p = doc.data();
    p.id = doc.id;
    inventoryData.push(p);
  });
  renderInventoryTable();
}

async function loadCompanyProducts(company) {
  const q = query(collection(db, 'products'), where('company', '==', company));
  const snap = await getDocs(q);
  inventoryData = [];
  snap.forEach(doc => {
    const p = doc.data();
    p.id = doc.id;
    inventoryData.push(p);
  });
  renderInventoryTable();
}

function renderInventoryTable() {
  const filterValue = (document.getElementById('inventoryFilter')?.value || '').toLowerCase();
  let filtered = inventoryData;
  if (filterValue) {
    filtered = inventoryData.filter(p => p.name.toLowerCase().includes(filterValue));
  }

  // Sort based on type and date field
  filtered.sort((a, b) => {
    if (a.type === 'wet' && b.type === 'wet') {
      // FIFO by receivedDate (or productDate if that's what you use)
      return new Date(a.receivedDate || a.productDate) - new Date(b.receivedDate || b.productDate);
    }
    if (a.type === 'dry' && b.type === 'dry') {
      // FEFO by expirationDate
      return new Date(a.expirationDate || a.productDate) - new Date(b.expirationDate || b.productDate);
    }
    if (a.type === 'appliance' && b.type === 'appliance') {
      // FIFO by manufacturingDate
      return new Date(a.manufacturingDate || a.productDate) - new Date(b.manufacturingDate || b.productDate);
    }
    // Otherwise, keep original order or sort by name
    return a.name.localeCompare(b.name);
  });

  const totalPages = Math.ceil(filtered.length / inventoryPageSize);
  if (inventoryCurrentPage > totalPages) inventoryCurrentPage = totalPages || 1;
  const start = (inventoryCurrentPage - 1) * inventoryPageSize;
  const pageData = filtered.slice(start, start + inventoryPageSize);

  const productTable = document.getElementById('productTable').querySelector('tbody');
  productTable.innerHTML = '';
  pageData.forEach(p => {
    productTable.innerHTML += `<tr class="border-b text-sm">
      <td class="p-2">${p.name}</td>
      <td class="p-2">${p.type}</td>
      <td class="p-2">${p.qty}</td>
      <td class="p-2">₱${p.price}</td>
      <td class="p-2">${
        p.type === 'wet' ? (p.receivedDate || p.productDate) :
        p.type === 'dry' ? (p.expirationDate || p.productDate) :
        p.type === 'appliance' ? (p.manufacturingDate || p.productDate) :
        p.productDate
      }</td>
      <td class="p-2">${p.approved ? '✅' : '⏳'}</td>
      <td class="p-2"><canvas id="qr-${p.id}" width="48" height="48"></canvas></td>
    </tr>`;
    QRCode.toCanvas(document.getElementById(`qr-${p.id}`), JSON.stringify(p));
  });

  // Pagination controls
  const pagination = document.getElementById('inventoryPagination');
  if (pagination) {
    pagination.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = 'px-2 py-1 mx-1 rounded ' + (i === inventoryCurrentPage ? 'bg-blue-600 text-white' : 'bg-gray-200');
      btn.onclick = () => {
        inventoryCurrentPage = i;
        renderInventoryTable();
      };
      pagination.appendChild(btn);
    }
  }
}

// Add event listener for filter
document.getElementById('inventoryFilter')?.addEventListener('input', () => {
  inventoryCurrentPage = 1;
  renderInventoryTable();
});

const profileModal = document.getElementById('profileModal');
const closeProfileModal = document.getElementById('closeProfileModal');
const profileForm = document.getElementById('profileForm');

function showProfileModal() {
  profileModal.classList.remove('hidden');
  (async () => {
    const uid = auth.currentUser?.uid;
    if (!uid) return;
    const userDoc = await getDoc(doc(db, 'users', uid));
    if (userDoc.exists()) {
      const data = userDoc.data();
      document.getElementById('profileFirstName').value = data.firstName || '';
      document.getElementById('profileMiddleName').value = data.middleName || '';
      document.getElementById('profileLastName').value = data.lastName || '';
      document.getElementById('profileBirthday').value = data.birthday || '';
      document.getElementById('profileMobile').value = data.mobile || '';
      document.getElementById('profileFacebook').value = data.facebook || '';
      document.getElementById('profileInstagram').value = data.instagram || '';
      document.getElementById('profileViber').value = data.viber || '';
      document.getElementById('profileWhatsApp').value = data.whatsapp || '';
      document.getElementById('profileTikTok').value = data.tiktok || '';
      document.getElementById('profileTelegram').value = data.telegram || '';
      document.getElementById('profileBranch').value = data.branch || '';
      document.getElementById('profileAddress').value = data.address || '';
      document.getElementById('profileGender').value = data.gender || '';
      document.getElementById('profileMaritalStatus').value = data.maritalStatus || '';
      document.getElementById('profileEmail').value = data.email || auth.currentUser.email || '';
      // New fields
      document.getElementById('profileCompany').value = data.company || '';
      document.getElementById('profilePosition').value = data.position || '';
      document.getElementById('profileDepartment').value = data.department || '';
      // Make fields readonly for users
      if (role === 'user') {
        document.getElementById('profilePosition').readOnly = true;
        document.getElementById('profileDepartment').readOnly = true;
        document.getElementById('profileBranch').readOnly = true; // <-- Add this line
        document.getElementById('profileCompany').readOnly = true; // (optional, if you want company locked too)
      } else {
        document.getElementById('profilePosition').readOnly = false;
        document.getElementById('profileDepartment').readOnly = false;
        document.getElementById('profileBranch').readOnly = false; // <-- Admins can edit
        document.getElementById('profileCompany').readOnly = false;
      }
    } else {
      document.getElementById('profileEmail').value = auth.currentUser.email || '';
    }
  })();
}

closeProfileModal.onclick = () => profileModal.classList.add('hidden');
profileModal.onclick = (e) => { if (e.target === profileModal) profileModal.classList.add('hidden'); };

profileForm.onsubmit = async (e) => {
  e.preventDefault();
  const uid = auth.currentUser.uid;
  await updateDoc(doc(db, 'users', uid), {
    firstName: document.getElementById('profileFirstName').value,
    middleName: document.getElementById('profileMiddleName').value,
    lastName: document.getElementById('profileLastName').value,
    birthday: document.getElementById('profileBirthday').value,
    address: document.getElementById('profileAddress').value,
    gender: document.getElementById('profileGender').value,
    maritalStatus: document.getElementById('profileMaritalStatus').value,
    email: document.getElementById('profileEmail').value,
    mobile: document.getElementById('profileMobile').value,
    facebook: document.getElementById('profileFacebook').value,
    instagram: document.getElementById('profileInstagram').value,
    viber: document.getElementById('profileViber').value,
    whatsapp: document.getElementById('profileWhatsApp').value,
    tiktok: document.getElementById('profileTikTok').value,
    telegram: document.getElementById('profileTelegram').value,
    branch: document.getElementById('profileBranch').value,
    // New fields
    company: document.getElementById('profileCompany').value,
    position: document.getElementById('profilePosition').value,
    department: document.getElementById('profileDepartment').value
  });
  const newPassword = document.getElementById('profilePassword').value;
  if (newPassword) {
    try {
      await auth.currentUser.updatePassword(newPassword);
      alert('Password updated.');
    } catch (err) {
      alert('Password update failed: ' + err.message);
    }
  }
  alert('Profile updated.');
  profileModal.classList.add('hidden');
};

function loadEndUserTabs() {


  // My Sold Products
  const soldBtn = document.createElement('button');
  soldBtn.textContent = 'My Sold Products';
  soldBtn.className = 'px-4 py-2 bg-green-100 rounded';
  soldBtn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden'); // <-- Hide POS panel
    roleContent.innerHTML = `
      <h2 class="text-lg font-bold mb-4">My Sold Products</h2>
      <input type="text" id="soldFilter" placeholder="Filter by name..." class="border p-2 rounded mb-2" />
      <div id="soldPagination" class="mt-2 mb-2"></div>
      <table class="w-full bg-white rounded shadow text-sm">
        <thead class='bg-gray-100'>
          <tr>
            <th class='p-2'>Name</th>
            <th class='p-2'>Type</th>
            <th class='p-2'>Qty Sold</th>
            <th class='p-2'>Price</th>
            <th class='p-2'>Date</th>
          </tr>
        </thead>
        <tbody id="soldTableBody"></tbody>
      </table>
    `;

    // Fetch sold products and sales
    const productsSnap = await getDocs(query(collection(db, 'products'), where('addedBy', '==', auth.currentUser.uid), where('approved', '==', true)));
    const salesSnap = await getDocs(query(collection(db, 'sales'), where('soldBy', '==', auth.currentUser.uid)));
    const salesMap = {};
    salesSnap.forEach(doc => {
      const sale = doc.data();
      salesMap[sale.productId] = (salesMap[sale.productId] || 0) + sale.quantity;
    });

    // Prepare data for table
    let soldProducts = [];
    productsSnap.forEach(doc => {
      const p = doc.data();
      const sold = salesMap[doc.id] || 0;
      if (sold > 0) {
        soldProducts.push({
          name: p.name,
          type: p.type,
          qtySold: sold,
          price: p.price,
          productDate: p.productDate
        });
      }
    });

    // Pagination variables
    let soldCurrentPage = 1;
    const soldPageSize = 10;

    function renderSoldTable() {
      const filterValue = (document.getElementById('soldFilter')?.value || '').toLowerCase();
      let filtered = soldProducts;
      if (filterValue) {
        filtered = soldProducts.filter(p => p.name.toLowerCase().includes(filterValue));
      }
      const totalPages = Math.ceil(filtered.length / soldPageSize);
      if (soldCurrentPage > totalPages) soldCurrentPage = totalPages || 1;
      const start = (soldCurrentPage - 1) * soldPageSize;
      const pageData = filtered.slice(start, start + soldPageSize);

      const tbody = document.getElementById('soldTableBody');
      tbody.innerHTML = '';
      pageData.forEach(p => {
        tbody.innerHTML += `<tr class="border-b">
          <td class="p-2">${p.name}</td>
          <td class="p-2">${p.type}</td>
          <td class="p-2">${p.qtySold}</td>
          <td class="p-2">₱${p.price}</td>
          <td class="p-2">${p.productDate}</td>
        </tr>`;
      });

      // Pagination controls
      const pagination = document.getElementById('soldPagination');
      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'px-2 py-1 mx-1 rounded ' + (i === soldCurrentPage ? 'bg-blue-600 text-white' : 'bg-gray-200');
        btn.onclick = () => {
          soldCurrentPage = i;
          renderSoldTable();
        };
        pagination.appendChild(btn);
      }
    }

    // Filter event
    document.getElementById('soldFilter').addEventListener('input', () => {
      soldCurrentPage = 1;
      renderSoldTable();
    });

    renderSoldTable();
  };
  roleTabs.appendChild(soldBtn);

  // My Inventory (all products added by user, regardless of approval)
  const inventoryBtn = document.createElement('button');
  inventoryBtn.textContent = 'My Inventory';
  inventoryBtn.className = 'px-4 py-2 bg-yellow-100 rounded';
  inventoryBtn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden'); // <-- Hide POS panel
    roleContent.innerHTML = `
      <h2 class="text-lg font-bold mb-4">My Inventory</h2>
      <input type="text" id="inventoryFilter" placeholder="Filter by name..." class="border p-2 rounded mb-2" />
      <div id="inventoryPagination" class="mt-2 mb-2"></div>
      <table id="productTable" class="w-full bg-white rounded shadow text-sm">
        <thead class='bg-gray-100'>
          <tr>
            <th class='p-2'>Photo</th>
            <th class='p-2'>Name</th>
            <th class='p-2'>Type</th>
            <th class='p-2'>Qty</th>
            <th class='p-2'>Price</th>
            <th class='p-2'>Date</th>
            <th class='p-2'>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    `;
    document.getElementById('inventoryFilter').addEventListener('input', () => {
      inventoryCurrentPage = 1;
      renderInventoryTable();
    });
    await loadUserProducts();
  };
  roleTabs.appendChild(inventoryBtn);

  // My Profile as modal
  const profileBtn = document.createElement('button');
  profileBtn.textContent = 'My Profile';
  profileBtn.className = 'px-4 py-2 bg-blue-100 rounded';
  profileBtn.onclick = showProfileModal;
  roleTabs.appendChild(profileBtn);

  // Add Product Tab
  const addProductBtn = document.createElement('button');
  addProductBtn.textContent = 'Add Product';
  addProductBtn.className = 'px-4 py-2 bg-blue-100 rounded';
  addProductBtn.onclick = () => {
    roleContent.innerHTML = '';
    document.getElementById('posPanel').classList.remove('hidden');
    hidePosPanels();
    document.getElementById('addProductPanel').classList.remove('hidden');
  };
  roleTabs.appendChild(addProductBtn);

  // Sell Product Tab
  const sellProductBtn = document.createElement('button');
  sellProductBtn.textContent = 'Sell Product';
  sellProductBtn.className = 'px-4 py-2 bg-green-100 rounded';
  sellProductBtn.onclick = () => {
    roleContent.innerHTML = '';
    document.getElementById('posPanel').classList.remove('hidden');
    hidePosPanels();
    document.getElementById('sellProductPanel').classList.remove('hidden');
    loadSellableProductsForRole({ allCompanies: true });
  };
  roleTabs.appendChild(sellProductBtn);
}

async function loadAdminTabs() {
  // Clear previous tabs and content
  roleTabs.innerHTML = '';
  roleContent.innerHTML = '';

  const attendanceBtn = document.createElement('button');
  attendanceBtn.textContent = 'Attendance Logs';
  attendanceBtn.className = 'px-4 py-2 bg-green-100 rounded';
  attendanceBtn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden');
    document.getElementById('superadminPanel').classList.add('hidden');
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">User Attendance Logs</h2>';
    const snap = await getDocs(query(collection(db, 'attendance'), orderBy('timestamp', 'desc')));
    const usersSnap = await getDocs(collection(db, 'users'));
    const userRoles = {};
    usersSnap.forEach(doc => {
      userRoles[doc.id] = doc.data().role;
    });

    const table = document.createElement('table');
    table.className = 'w-full bg-white rounded shadow text-sm';
    table.innerHTML = `<thead class='bg-gray-100'>
      <tr>
        <th class='p-2'>User</th>
        <th class='p-2'>Date</th>
        <th class='p-2'>Time</th>
        <th class='p-2'>Action</th>
      </tr>
    </thead>
    <tbody id='attendanceTable'></tbody>`;
    const body = table.querySelector('tbody');
    snap.forEach(doc => {
      const a = doc.data();
      const d = a.timestamp.toDate();
      const role = userRoles[a.uid] || '';
      // Only show if role is 'user' or 'admin'
      if (role === 'user' || role === 'admin') {
        body.innerHTML += `<tr class='border-b'>
          <td class='p-2'>${a.email} (${role})</td>
          <td class='p-2'>${d.toLocaleDateString()}</td>
          <td class='p-2'>${d.toLocaleTimeString()}</td>
          <td class='p-2'>${a.action || ''}</td>
        </tr>`;
      }
    });
    // Export CSV Button
    const exportBtn = document.createElement('button');
    exportBtn.textContent = 'Export CSV';
    exportBtn.className = 'mt-4 px-4 py-2 bg-green-600 text-white rounded';
    exportBtn.onclick = () => {
      const rows = [['Email', 'Date', 'Time', 'Action']];
      snap.forEach(doc => {
        const a = doc.data();
        const d = a.timestamp.toDate();
        const role = userRoles[a.uid];
        if (role === 'user' || role === 'admin') {
          rows.push([
            a.email + ' (' + (role || '') + ')',
            d.toLocaleDateString(),
            d.toLocaleTimeString(),
            a.action || ''
          ]);
        }
      });
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'attendance_logs.csv';
      link.click();
    };
    roleContent.appendChild(table);
    roleContent.appendChild(exportBtn);

    // Chart (optional, filtered)
    const chartCanvas = document.createElement('canvas');
    chartCanvas.id = 'attendanceChart';
    chartCanvas.className = 'my-6';
    roleContent.appendChild(chartCanvas);

    const counts = {};
    snap.forEach(doc => {
      const a = doc.data();
      const d = a.timestamp.toDate();
      const role = userRoles[a.uid];
      if (role === 'user' || role === 'admin') {
        const dateStr = d.toLocaleDateString();
        counts[dateStr] = (counts[dateStr] || 0) + 1;
      }
    });
    new Chart(chartCanvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: 'Logins per Day',
          data: Object.values(counts),
          backgroundColor: 'rgba(59, 130, 246, 0.2)',
          borderColor: 'rgba(59, 130, 246, 1)',
          borderWidth: 2,
          fill: true
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  };
  roleTabs.appendChild(attendanceBtn);
  const btn = document.createElement('button');
  btn.textContent = 'Approve Products';
  btn.className = 'px-4 py-2 bg-yellow-200 rounded';
  btn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden');
    document.getElementById('superadminPanel').classList.add('hidden');
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">Pending Products</h2>';
    const table = document.createElement('table');
    table.className = 'w-full text-sm';
    const q = query(collection(db, 'products'), where('approved', '==', false));
    const snap = await getDocs(q);
    snap.forEach(docSnap => {
      const p = docSnap.data();
      const row = `<tr class="border-b">
        <td class="p-2">${p.name}</td>
        <td class="p-2">${p.productDate}</td>
        <td class="p-2"><button onclick="approveProduct('${docSnap.id}')" class="bg-green-600 text-white px-2 py-1 rounded">Approve</button></td>
      </tr>`;
      table.innerHTML += row;
    });
    roleContent.appendChild(table);
  };
  roleTabs.appendChild(btn);

  // My Profile as modal
  const profileBtn = document.createElement('button');
  profileBtn.textContent = 'My Profile';
  profileBtn.className = 'px-4 py-2 bg-yellow-100 rounded';
  profileBtn.onclick = showProfileModal;
  roleTabs.appendChild(profileBtn);

  // Manage Users
  const manageBtn = document.createElement('button');
  manageBtn.textContent = 'Manage Users';
  manageBtn.className = 'px-4 py-2 bg-red-100 rounded';
  manageBtn.onclick = async () => {
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">User Management</h2>';
    const snap = await getDocs(query(collection(db, 'users'), where('role', '==', 'user')));
    const table = document.createElement('table');
    table.className = 'w-full bg-white rounded shadow text-sm mb-4';
    table.innerHTML = `<thead class='bg-gray-100'>
      <tr>
        <th class='p-2'>Email</th>
        <th class='p-2'>Role</th>
        <th class='p-2'>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>`;
    const body = table.querySelector('tbody');
    snap.forEach(doc => {
      const u = doc.data();
      body.innerHTML += `<tr class="border-b">
        <td class="p-2">${u.email}</td>
        <td class="p-2">${u.role}</td>
        <td class="p-2">
          <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="editUser('${doc.id}', '${u.email}', '${u.role}')">Edit</button>
          <button class="bg-red-600 text-white px-2 py-1 rounded" onclick="deleteUser('${doc.id}')">Delete</button>
        </td>
      </tr>`;
    });
    roleContent.appendChild(table);

    // Add User Form
    const form = document.createElement('form');
    form.className = 'space-y-2';
    form.innerHTML = `
      <input type="email" id="newUserEmail" placeholder="Email" class="border p-2 rounded w-1/3" required />
      <input type="password" id="newUserPassword" placeholder="Password" class="border p-2 rounded w-1/3" required />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Add</button>
    `;
    form.onsubmit = async (e) => {
      e.preventDefault();
      const email = form.querySelector('#newUserEmail').value;
      const password = form.querySelector('#newUserPassword').value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', cred.user.uid), { email, role: 'user' });
        alert('User created!');
        manageBtn.onclick(); // reload
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };
    roleContent.appendChild(form);
  };
  roleTabs.appendChild(manageBtn);

  // Get admin's company from user profile
  let adminCompany = '';
  const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
  if (userDoc.exists()) {
    adminCompany = userDoc.data().company || '';
  }

  // Company Inventory Tab
  const companyInventoryBtn = document.createElement('button');
  companyInventoryBtn.textContent = 'Company Inventory';
  companyInventoryBtn.className = 'px-4 py-2 bg-yellow-100 rounded';
  companyInventoryBtn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden');
    roleContent.innerHTML = `
      <h2 class="text-lg font-bold mb-4">Company Inventory</h2>
      <input type="text" id="companyInventoryFilter" placeholder="Filter by name..." class="border p-2 rounded mb-2" />
      <div id="companyInventoryPagination" class="mt-2 mb-2"></div>
      <table id="companyInventoryTable" class="w-full bg-white rounded shadow text-sm">
        <thead class='bg-gray-100'>
          <tr>
            <th class='p-2'>Name</th>
            <th class='p-2'>Type</th>
            <th class='p-2'>Qty</th>
            <th class='p-2'>Price</th>
            <th class='p-2'>Date</th>
            <th class='p-2'>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    `;
    await loadCompanyInventory(adminCompany);
    document.getElementById('companyInventoryFilter').addEventListener('input', () => {
      companyInventoryCurrentPage = 1;
      renderCompanyInventoryTable();
    });
  };
  roleTabs.appendChild(companyInventoryBtn);

  // Company Sold Products Tab
  const companySoldBtn = document.createElement('button');
  companySoldBtn.textContent = 'Company Sold Products';
  companySoldBtn.className = 'px-4 py-2 bg-green-100 rounded';
  companySoldBtn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden');
    roleContent.innerHTML = `
      <h2 class="text-lg font-bold mb-4">Company Sold Products</h2>
      <input type="text" id="companySoldFilter" placeholder="Filter by name..." class="border p-2 rounded mb-2" />
      <div id="companySoldPagination" class="mt-2 mb-2"></div>
      <table class="w-full bg-white rounded shadow text-sm">
        <thead class='bg-gray-100'>
          <tr>
            <th class='p-2'>Name</th>
            <th class='p-2'>Type</th>
            <th class='p-2'>Qty Sold</th>
            <th class='p-2'>Price</th>
            <th class='p-2'>Date</th>
          </tr>
        </thead>
        <tbody id="companySoldTableBody"></tbody>
      </table>
    `;
    await loadCompanySoldProducts(adminCompany);
    document.getElementById('companySoldFilter').addEventListener('input', () => {
      companySoldCurrentPage = 1;
      renderCompanySoldTable();
    });
  };
  roleTabs.appendChild(companySoldBtn);

  // Employee List Tab
  const employeeListBtn = document.createElement('button');
  employeeListBtn.textContent = 'Employee List';
  employeeListBtn.className = 'px-4 py-2 bg-blue-100 rounded';
  employeeListBtn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden');
    roleContent.innerHTML = `
      <h2 class="text-lg font-bold mb-4">Employee List</h2>
      <table class="w-full bg-white rounded shadow text-sm mb-4">
        <thead class='bg-gray-100'>
          <tr>
            <th class='p-2'>Name</th>
            <th class='p-2'>Email</th>
            <th class='p-2'>Position</th>
            <th class='p-2'>Department</th>
            <th class='p-2'>Profile</th>
          </tr>
        </thead>
        <tbody id="employeeTable"></tbody>
      </table>
    `;

    // Query users with the same company and role 'user'
    const snap = await getDocs(query(
      collection(db, 'users'),
      where('company', '==', adminCompany),
      where('role', '==', 'user')
    ));
    const tbody = document.getElementById('employeeTable');
    snap.forEach(docSnap => {
      const u = docSnap.data();
      tbody.innerHTML += `
        <tr class="border-b">
          <td class="p-2">${u.firstName || ''} ${u.lastName || ''}</td>
          <td class="p-2">${u.email}</td>
          <td class="p-2">${u.position || ''}</td>
          <td class="p-2">${u.department || ''}</td>
          <td class="p-2">
            <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="viewEmployeeProfile('${docSnap.id}')">View</button>
          </td>
        </tr>
      `;
    });
  };
  roleTabs.appendChild(employeeListBtn);
}

// --- Company Inventory ---
let companyInventoryData = [];
let companyInventoryCurrentPage = 1;
const companyInventoryPageSize = 10;

async function loadCompanyInventory(company) {
  const q = query(collection(db, 'products'), where('company', '==', company));
  const snap = await getDocs(q);
  companyInventoryData = [];
  snap.forEach(doc => {
    const p = doc.data();
    p.id = doc.id;
    companyInventoryData.push(p);
  });
  renderCompanyInventoryTable();
}

function renderCompanyInventoryTable() {
  const filterValue = (document.getElementById('companyInventoryFilter')?.value || '').toLowerCase();
  let filtered = companyInventoryData;
  if (filterValue) {
    filtered = companyInventoryData.filter(p => p.name.toLowerCase().includes(filterValue));
  }
  const totalPages = Math.ceil(filtered.length / companyInventoryPageSize);
  if (companyInventoryCurrentPage > totalPages) companyInventoryCurrentPage = totalPages || 1;
  const start = (companyInventoryCurrentPage - 1) * companyInventoryPageSize;
  const pageData = filtered.slice(start, start + companyInventoryPageSize);

  const table = document.getElementById('companyInventoryTable').querySelector('tbody');
  table.innerHTML = '';
  pageData.forEach(p => {
    table.innerHTML += `<tr class="border-b text-sm">
      <td class="p-2">${p.name}</td>
      <td class="p-2">${p.type}</td>
      <td class="p-2">${p.qty}</td>
      <td class="p-2">₱${p.price}</td>
      <td class="p-2">${p.productDate}</td>
      <td class="p-2">${p.approved ? '✅' : '⏳'}</td>
    </tr>`;
  });

  // Pagination controls
  const pagination = document.getElementById('companyInventoryPagination');
  if (pagination) {
    pagination.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = 'px-2 py-1 mx-1 rounded ' + (i === companyInventoryCurrentPage ? 'bg-blue-600 text-white' : 'bg-gray-200');
      btn.onclick = () => {
        companyInventoryCurrentPage = i;
        renderCompanyInventoryTable();
      };
      pagination.appendChild(btn);
    }
  }
}

// --- Company Sold Products ---
let companySoldData = [];
let companySoldCurrentPage = 1;
const companySoldPageSize = 10;

async function loadCompanySoldProducts(company) {
  // Get all products for this company
  const productsSnap = await getDocs(query(collection(db, 'products'), where('company', '==', company), where('approved', '==', true)));
  const salesSnap = await getDocs(query(collection(db, 'sales')));
  const salesMap = {};
  salesSnap.forEach(doc => {
    const sale = doc.data();
    salesMap[sale.productId] = (salesMap[sale.productId] || 0) + sale.quantity;
  });

  companySoldData = [];
  productsSnap.forEach(doc => {
    const p = doc.data();
    const sold = salesMap[doc.id] || 0;
    if (sold > 0) {
      companySoldData.push({
        name: p.name,
        type: p.type,
        qtySold: sold,
        price: p.price,
        productDate: p.productDate
      });
    }
  });
  renderCompanySoldTable();
}

function renderCompanySoldTable() {
  const filterValue = (document.getElementById('companySoldFilter')?.value || '').toLowerCase();
  let filtered = companySoldData;
  if (filterValue) {
    filtered = companySoldData.filter(p => p.name.toLowerCase().includes(filterValue));
  }
  const totalPages = Math.ceil(filtered.length / companySoldPageSize);
  if (companySoldCurrentPage > totalPages) companySoldCurrentPage = totalPages || 1;
  const start = (companySoldCurrentPage - 1) * companySoldPageSize;
  const pageData = filtered.slice(start, start + companySoldPageSize);

  const tbody = document.getElementById('companySoldTableBody');
  tbody.innerHTML = '';
  pageData.forEach(p => {
    tbody.innerHTML += `<tr class="border-b">
      <td class="p-2">${p.name}</td>
      <td class="p-2">${p.type}</td>
      <td class="p-2">${p.qtySold}</td>
      <td class="p-2">₱${p.price}</td>
      <td class="p-2">${p.productDate}</td>
    </tr>`;
  });

  // Pagination controls
  const pagination = document.getElementById('companySoldPagination');
  if (pagination) {
    pagination.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = 'px-2 py-1 mx-1 rounded ' + (i === companySoldCurrentPage ? 'bg-blue-600 text-white' : 'bg-gray-200');
      btn.onclick = () => {
        companySoldCurrentPage = i;
        renderCompanySoldTable();
      };
      pagination.appendChild(btn);
    }
  }
}

window.viewEmployeeProfile = async function(uid) {
  const userDoc = await getDoc(doc(db, 'users', uid));
  if (!userDoc.exists()) return alert('User not found!');
  const data = userDoc.data();

  // Show modal or panel with user info (read-only)
  roleContent.innerHTML = `
    <h2 class="text-lg font-bold mb-4">Employee Profile</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <div class="mb-2"><b>Name:</b> ${data.firstName || ''} ${data.lastName || ''}</div>
        <div class="mb-2"><b>Email:</b> ${data.email || ''}</div>
        <div class="mb-2"><b>Position:</b> ${data.position || ''}</div>
        <div class="mb-2"><b>Department:</b> ${data.department || ''}</div>
        <div class="mb-2"><b>Company:</b> <input type="text" value="${data.company || ''}" class="border p-2 rounded w-full bg-gray-100" readonly /></div>
        <div class="mb-2"><b>Branch:</b> ${data.branch || ''}</div>
        <div class="mb-2"><b>Mobile:</b> ${data.mobile || ''}</div>
        <div class="mb-2"><b>Birthday:</b> ${data.birthday || ''}</div>
        <div class="mb-2"><b>Address:</b> ${data.address || ''}</div>
      </div>
    </div>
    <button class="mt-4 px-4 py-2 bg-gray-400 text-white rounded" onclick="loadAdminTabs()">Back</button>
  `;
};

// Approve product handler for admin
window.approveProduct = async function(productId) {
  try {
    await updateDoc(doc(db, 'products', productId), { approved: true });
    alert('Product approved!');
    // Optionally reload the approve products tab
    if (typeof loadAdminTabs === 'function') loadAdminTabs();
  } catch (err) {
    alert('Failed to approve product: ' + err.message);
  }
};

function hidePosPanels() {
  document.getElementById('addProductPanel').classList.add('hidden');
  document.getElementById('sellProductPanel').classList.add('hidden');
  document.getElementById('bundleSellPanel').classList.add('hidden');
}

// Sellable Products
async function loadSellableProducts() {
  // Fetch all products the user can sell, grouped by name/type for selection
  const q = query(collection(db, 'products'), where('addedBy', '==', auth.currentUser.uid), where('approved', '==', true));
  const snap = await getDocs(q);
  const products = [];
  snap.forEach(doc => {
    const p = doc.data();
    products.push({ id: doc.id, ...p });
  });

  // Group products by name+type for selection (so user sees one entry per product)
  const grouped = {};
  products.forEach(p => {
    const key = `${p.name} (${p.type})`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(p);
  });

  const container = document.getElementById('sellProductList');
  container.innerHTML = `
    <form id="multiSellForm" class="space-y-4">
      <div class="flex gap-2 mb-2">
        <input list="productList" id="productSelect" placeholder="Select product..." class="border p-2 rounded flex-1" autocomplete="off" />
        <datalist id="productList">
          ${Object.keys(grouped).map(key => `<option value="${key}"></option>`).join('')}
        </datalist>
        <input type="number" id="productQtySell" min="1" placeholder="Qty" class="border p-2 rounded w-24" />
        <button type="button" id="addToSellList" class="bg-blue-600 text-white px-4 py-2 rounded">Add</button>
      </div>
      <div>
        <table class="w-full bg-white rounded shadow text-sm mb-2">
          <thead>
            <tr>
              <th class="p-2">Product</th>
              <th class="p-2">Qty</th>
              <th class="p-2">Unit Price</th>
              <th class="p-2">Total Price</th>
              <th class="p-2">Remove</th>
            </tr>
          </thead>
          <tbody id="sellItemsTable"></tbody>
        </table>
        <div class="text-right font-semibold mt-2">
          Grand Total: ₱<span id="grandTotalSell">0.00</span>
        </div>
      </div>
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Sell Selected Items</button>
    </form>
  `;

  const sellItems = [];
  const sellItemsTable = document.getElementById('sellItemsTable');
  const grandTotalSpan = document.getElementById('grandTotalSell');

  // Add to list handler
  document.getElementById('addToSellList').onclick = () => {
    const nameInput = document.getElementById('productSelect').value.trim();
    const qtyInput = parseInt(document.getElementById('productQtySell').value, 10);
    if (!nameInput || !qtyInput || qtyInput < 1) return alert('Select a product and enter a valid quantity.');

    // Find all batches for this product
    const batches = grouped[nameInput];
    if (!batches) return alert('Product not found.');

    // Calculate total available qty
    const totalAvailable = batches.reduce((sum, p) => sum + p.qty, 0);
    if (qtyInput > totalAvailable) return alert('Not enough stock.');

    // Prevent duplicate
    if (sellItems.some(item => item.key === nameInput)) return alert('Product already added.');

    // Use price of the oldest/soonest-expiring batch for display
    let displayPrice = batches[0].price;
    if (batches[0].type === 'wet') {
      batches.sort((a, b) => new Date(a.receivedDate || a.productDate) - new Date(b.receivedDate || b.productDate));
      displayPrice = batches[0].price;
    } else if (batches[0].type === 'dry') {
      batches.sort((a, b) => new Date(a.expirationDate || a.productDate) - new Date(b.expirationDate || b.productDate));
      displayPrice = batches[0].price;
    } else if (batches[0].type === 'appliance') {
      batches.sort((a, b) => new Date(a.manufacturingDate || a.productDate) - new Date(b.manufacturingDate || b.productDate));
      displayPrice = batches[0].price;
    }

    sellItems.push({ key: nameInput, qty: qtyInput, price: displayPrice, batches });
    renderSellItems();
    document.getElementById('productSelect').value = '';
    document.getElementById('productQtySell').value = '';
  };

  function renderSellItems() {
    sellItemsTable.innerHTML = '';
    let grandTotal = 0;
    sellItems.forEach((item, idx) => {
      const total = item.qty * item.price;
      grandTotal += total;
      sellItemsTable.innerHTML += `
        <tr>
          <td class="p-2">${item.key}</td>
          <td class="p-2">${item.qty}</td>
          <td class="p-2">₱${item.price.toFixed(2)}</td>
          <td class="p-2">₱${total.toFixed(2)}</td>
          <td class="p-2"><button type="button" class="text-red-600" data-idx="${idx}">Remove</button></td>
        </tr>
      `;
    });
    // Remove handler
    sellItemsTable.querySelectorAll('button[data-idx]').forEach(btn => {
      btn.onclick = () => {
        sellItems.splice(parseInt(btn.dataset.idx, 10), 1);
        renderSellItems();
      };
    });
    grandTotalSpan.textContent = grandTotal.toFixed(2);
  }

  // Handle form submission (FIFO/FEFO deduction)
  document.getElementById('multiSellForm').onsubmit = async (e) => {
    e.preventDefault();
    if (sellItems.length === 0) return alert('Add at least one product.');
    for (const item of sellItems) {
      let qtyToSell = item.qty;
      // Sort batches by FIFO/FEFO
      let batches = [...item.batches];
      if (batches[0].type === 'wet') {
        batches.sort((a, b) => new Date(a.receivedDate || a.productDate) - new Date(b.receivedDate || b.productDate));
      } else if (batches[0].type === 'dry') {
        batches.sort((a, b) => new Date(a.expirationDate || a.productDate) - new Date(b.expirationDate || b.productDate));
      } else if (batches[0].type === 'appliance') {
        batches.sort((a, b) => new Date(a.manufacturingDate || a.productDate) - new Date(b.manufacturingDate || b.productDate));
      }
      for (const batch of batches) {
        if (qtyToSell <= 0) break;
        const sellQty = Math.min(batch.qty, qtyToSell);
        if (sellQty > 0) {
          // Update product batch qty
          const productRef = doc(db, 'products', batch.id);
          await updateDoc(productRef, { qty: batch.qty - sellQty });
          // Add sales record
          await addDoc(collection(db, 'sales'), {
            productId: batch.id,
            soldBy: auth.currentUser.uid,
            quantity: sellQty,
            soldAt: Timestamp.now(),
            unitPrice: batch.price,
            totalPrice: sellQty * batch.price
          });
          qtyToSell -= sellQty;
        }
      }
    }
    alert('Products sold!');
    // Reload for the correct role
    if (allCompanies) {
      loadSellableProductsForRole({ allCompanies: true });
      if (typeof loadSuperAdminProducts === 'function') loadSuperAdminProducts();
    } else if (company) {
      loadSellableProductsForRole({ company });
      loadCompanyProducts(company);
    } else {
      loadSellableProductsForRole({});
      loadUserProducts();
    }
  };

  // Initial render
  renderSellItems();
}

async function loadSellableProductsForRole({ company = null, allCompanies = false } = {}) {
  // Query products based on role
  let q;
  if (allCompanies) {
    q = query(collection(db, 'products'), where('approved', '==', true));
  } else if (company) {
    q = query(collection(db, 'products'), where('company', '==', company), where('approved', '==', true));
  } else {
    q = query(collection(db, 'products'), where('addedBy', '==', auth.currentUser.uid), where('approved', '==', true));
  }
  const snap = await getDocs(q);
  const products = [];
  snap.forEach(doc => products.push({ id: doc.id, ...doc.data() }));

  // Group by name+type(+company for superadmin)
  const grouped = {};
  products.forEach(p => {
    const key = allCompanies ? `${p.name} (${p.type}) [${p.company || ''}]` : `${p.name} (${p.type})`;
    (grouped[key] = grouped[key] || []).push(p);
  });

  // Render form
  document.getElementById('sellProductList').innerHTML = `
    <form id="multiSellForm">
      <div class="flex gap-2 mb-2">
        <input list="productList" id="productSelect" placeholder="Select product..." class="border p-2 rounded flex-1" autocomplete="off" />
        <datalist id="productList">${Object.keys(grouped).map(key => `<option value="${key}"></option>`).join('')}</datalist>
        <input type="number" id="productQtySell" min="1" placeholder="Qty" class="border p-2 rounded w-24" />
        <button type="button" id="addToSellList" class="bg-blue-600 text-white px-4 py-2 rounded">Add</button>
      </div>
      <table class="w-full bg-white rounded shadow text-sm mb-2">
        <thead><tr>
          <th class="p-2">Product</th><th class="p-2">Qty</th>
          <th class="p-2">Unit Price</th><th class="p-2">Total Price</th>
          <th class="p-2">Remove</th>
        </tr></thead>
        <tbody id="sellItemsTable"></tbody>
      </table>
      <div class="text-right font-semibold mt-2">Grand Total: ₱<span id="grandTotalSell">0.00</span></div>
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Sell Selected Items</button>
    </form>
  `;

  const sellItems = [];
  const sellItemsTable = document.getElementById('sellItemsTable');
  const grandTotalSpan = document.getElementById('grandTotalSell');

  // Add to list handler
  document.getElementById('addToSellList').onclick = () => {
    const nameInput = document.getElementById('productSelect').value.trim();
    const qtyInput = parseInt(document.getElementById('productQtySell').value, 10);
    const batches = grouped[nameInput];
    if (!nameInput || !qtyInput || qtyInput < 1 || !batches) return alert('Select a product and enter a valid quantity.');
    const totalAvailable = batches.reduce((sum, p) => sum + p.qty, 0);
    if (qtyInput > totalAvailable) return alert('Not enough stock.');
    if (sellItems.some(item => item.key === nameInput)) return alert('Product already added.');

    // Sort for FIFO/FEFO
    let displayPrice = batches[0].price;
    if (batches[0].type === 'wet') batches.sort((a, b) => new Date(a.receivedDate || a.productDate) - new Date(b.receivedDate || b.productDate));
    else if (batches[0].type === 'dry') batches.sort((a, b) => new Date(a.expirationDate || a.productDate) - new Date(b.expirationDate || b.productDate));
    else if (batches[0].type === 'appliance') batches.sort((a, b) => new Date(a.manufacturingDate || a.productDate) - new Date(b.manufacturingDate || b.productDate));
    displayPrice = batches[0].price;

    sellItems.push({ key: nameInput, qty: qtyInput, price: displayPrice, batches });
    renderSellItems();
    document.getElementById('productSelect').value = '';
    document.getElementById('productQtySell').value = '';
  };

  function renderSellItems() {
    sellItemsTable.innerHTML = '';
    let grandTotal = 0;
    sellItems.forEach((item, idx) => {
      const total = item.qty * item.price;
      grandTotal += total;
      sellItemsTable.innerHTML += `
        <tr>
          <td class="p-2">${item.key}</td>
          <td class="p-2">${item.qty}</td>
          <td class="p-2">₱${item.price.toFixed(2)}</td>
          <td class="p-2">₱${total.toFixed(2)}</td>
          <td class="p-2"><button type="button" class="text-red-600" data-idx="${idx}">Remove</button></td>
        </tr>
      `;
    });
    // Remove handler
    sellItemsTable.querySelectorAll('button[data-idx]').forEach(btn => {
      btn.onclick = () => {
        sellItems.splice(parseInt(btn.dataset.idx, 10), 1);
        renderSellItems();
      };
    });
    grandTotalSpan.textContent = grandTotal.toFixed(2);
  }

  // FIFO/FEFO deduction on submit
  document.getElementById('multiSellForm').onsubmit = async (e) => {
    e.preventDefault();
    if (sellItems.length === 0) return alert('Add at least one product.');
    for (const item of sellItems) {
      let qtyToSell = item.qty;
      let batches = [...item.batches];
      if (batches[0].type === 'wet') batches.sort((a, b) => new Date(a.receivedDate || a.productDate) - new Date(b.receivedDate || b.productDate));
      else if (batches[0].type === 'dry') batches.sort((a, b) => new Date(a.expirationDate || a.productDate) - new Date(b.expirationDate || b.productDate));
      else if (batches[0].type === 'appliance') batches.sort((a, b) => new Date(a.manufacturingDate || a.productDate) - new Date(b.manufacturingDate || b.productDate));
      for (const batch of batches) {
        if (qtyToSell <= 0) break;
        const sellQty = Math.min(batch.qty, qtyToSell);
        if (sellQty > 0) {
          await updateDoc(doc(db, 'products', batch.id), { qty: batch.qty - sellQty });
          await addDoc(collection(db, 'sales'), {
            productId: batch.id,
            soldBy: auth.currentUser.uid,
            quantity: sellQty,
            soldAt: Timestamp.now(),
            unitPrice: batch.price,
            totalPrice: sellQty * batch.price
          });
          qtyToSell -= sellQty;
        }
      }
    }
    alert('Products sold!');
    // Reload for the correct role
    if (allCompanies) {
      loadSellableProductsForRole({ allCompanies: true });
      if (typeof loadSuperAdminProducts === 'function') loadSuperAdminProducts();
    } else if (company) {
      loadSellableProductsForRole({ company });
      loadCompanyProducts(company);
    } else {
      loadSellableProductsForRole({});
      loadUserProducts();
    }
  };

  // Initial render
  renderSellItems();
}
</script>


</body>
</html>