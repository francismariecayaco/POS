<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POS Inventory System</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  // Disable right-click, F12, inspect, view-source
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.onkeydown = function (e) {
    if (
      e.key === 'F12' ||
      (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) ||
      (e.ctrlKey && e.key === 'U')
    ) {
      return false;
    }
  };
</script>
</head>
<body class="bg-gray-50">

<!-- Login Panel -->
<div id="loginPanel" class="min-h-screen flex items-center justify-center">
  <div class="bg-white shadow rounded p-8 w-full max-w-md">
    <h2 class="text-2xl font-bold text-center mb-4">Login</h2>
    <form id="loginForm" class="space-y-4">
      <input type="email" id="loginEmail" placeholder="Email" class="w-full border p-2 rounded" required />
      <input type="password" id="loginPassword" placeholder="Password" class="w-full border p-2 rounded" required />
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Login</button>
      <div class="text-center">
        <a href="#" id="resetLink" class="text-sm text-blue-600 underline">Forgot Password?</a>
      </div>
    </form>
  </div>
</div>



<!-- Main Dashboard -->
<div id="dashboard" class="hidden">
  <nav class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-blue-700">Dashboard</h1>
    <div>
      <span id="userEmail" class="text-gray-600 mr-4"></span>
      <button onclick="logout()" class="text-red-600 font-semibold">Logout</button>
    </div>
  </nav>
  <div id="roleTabs" class="p-4 space-x-2"></div>
  <div id="roleContent" class="p-4"></div>
</div>

<!-- POS Panel -->
<div id="posPanel" class="hidden p-4">
  <div class="max-w-xl mx-auto bg-white p-4 rounded shadow">
    <h2 class="text-lg font-bold mb-4">Sell / Add Product</h2>
    <form id="productForm" class="space-y-4">
      <input type="text" id="productName" placeholder="Product Name" class="w-full border p-2 rounded" required />
      <select id="productType" class="w-full border p-2 rounded" required>
        <option value="wet">Wet Goods</option>
        <option value="dry">Dry Goods</option>
        <option value="appliance">Appliances</option>
      </select>
      <input type="number" id="productQty" placeholder="Quantity" class="w-full border p-2 rounded" required />
      <input type="number" id="productPrice" placeholder="Price" class="w-full border p-2 rounded" required />
      <input type="date" id="productDate" class="w-full border p-2 rounded" required />
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Add Product</button>
    </form>
    <div id="qrcode" class="mt-6 flex justify-center"></div>
  </div>
  <div class="mt-6">
    <h3 class="text-lg font-semibold mb-2">My Products</h3>
    <table class="w-full bg-white rounded shadow table-auto text-left">
      <thead class="bg-gray-100 text-sm">
        <tr>
          <th class="p-2">Name</th>
          <th class="p-2">Type</th>
          <th class="p-2">Qty</th>
          <th class="p-2">Price</th>
          <th class="p-2">Date</th>
          <th class="p-2">Status</th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>
  </div>
</div>

<!-- Super Admin Inventory View -->
<div id="superadminPanel" class="hidden p-4">
  <h2 class="text-lg font-bold mb-4">All Inventory (All Branches)</h2>
  <div class="flex gap-4 mb-4">
    <input type="text" id="filterBranch" placeholder="Filter by Branch..." class="border p-2 rounded w-1/2" />
    <select id="filterType" class="border p-2 rounded w-1/2">
      <option value="">All Types</option>
      <option value="wet">Wet Goods</option>
      <option value="dry">Dry Goods</option>
      <option value="appliance">Appliances</option>
    </select>
    <button id="exportCsvBtn" class="ml-auto px-4 py-2 bg-green-600 text-white rounded">Export CSV</button>
  </div>
  <canvas id="topProductsChart" class="w-full max-w-3xl mx-auto mb-8"></canvas>
  <div class="text-right font-semibold text-gray-700 mb-2" id="totalValuation"></div>
  <table class="w-full bg-white rounded shadow table-auto text-left">
    <thead class="bg-gray-100 text-sm">
      <tr>
        <th class="p-2">Name</th>
        <th class="p-2">Type</th>
        <th class="p-2">Qty</th>
        <th class="p-2">Price</th>
        <th class="p-2">Date</th>
        <th class="p-2">Added By</th>
        <th class="p-2">Alert</th>
      </tr>
    </thead>
    <tbody id="superadminTable"></tbody>
  </table>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded shadow-lg p-6 w-full max-w-2xl relative">
    <button id="closeProfileModal" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl">&times;</button>
    <h2 class="text-lg font-bold mb-4">My Profile</h2>
    <form id="profileForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <input type="text" id="profileFirstName" placeholder="First Name" class="border p-2 rounded" required />
        <input type="text" id="profileMiddleName" placeholder="Middle Name" class="border p-2 rounded" />
        <input type="text" id="profileLastName" placeholder="Last Name" class="border p-2 rounded" required />
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input type="date" id="profileBirthday" placeholder="Birthday" class="border p-2 rounded" required />
        <input type="text" id="profileMobile" placeholder="Mobile Number" class="border p-2" />
      </div>
      <div>
        <textarea id="profileAddress" placeholder="Address" class="border p-2 rounded w-full" rows="3" required></textarea>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <select id="profileGender" class="border p-2 rounded" required>
          <option value="">Gender</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
        <select id="profileMaritalStatus" class="border p-2 rounded" required>
          <option value="">Marital Status</option>
          <option>Single</option>
          <option>Married</option>
          <option>Divorced</option>
          <option>Widowed</option>
        </select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input type="email" id="profileEmail" placeholder="Email Address" class="border p-2 rounded" required />
        <input type="text" id="profileFacebook" placeholder="Facebook Account" class="border p-2 rounded" />
        <input type="text" id="profileInstagram" placeholder="Instagram Account" class="border p-2 rounded" />
        <input type="text" id="profileViber" placeholder="Viber Account" class="border p-2 rounded" />
        <input type="text" id="profileWhatsApp" placeholder="WhatsApp Account" class="border p-2 rounded" />
        <input type="text" id="profileTikTok" placeholder="TikTok Account" class="border p-2 rounded" />
        <input type="text" id="profileTelegram" placeholder="Telegram Account" class="border p-2 rounded" />
        <input type="text" id="profileBranch" placeholder="Store / Branch Designated" class="border p-2 rounded" required />
      </div>
      <!-- Add Company, Position, Department fields -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <input type="text" id="profileCompany" placeholder="Company" class="border p-2 rounded" />
        <input type="text" id="profilePosition" placeholder="Position" class="border p-2 rounded" />
        <input type="text" id="profileDepartment" placeholder="Department" class="border p-2 rounded" />
      </div>
      <input type="password" id="profilePassword" placeholder="New Password (leave blank to keep current)" class="border p-2 rounded w-full" />
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Save</button>
    </form>
  </div>
</div>

<!-- Add User/Admin Modal -->
<div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded shadow-lg p-6 w-full max-w-md relative">
    <button id="closeAddUserModal" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl">&times;</button>
    <h2 class="text-lg font-bold mb-4" id="addUserModalTitle">Add User</h2>
    <form id="addUserForm" class="space-y-4">
      <input type="email" id="modalUserEmail" placeholder="Email" class="w-full border p-2 rounded" required />
      <input type="password" id="modalUserPassword" placeholder="Password" class="w-full border p-2 rounded" required />
      <select id="modalUserRole" class="w-full border p-2 rounded">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Add</button>
    </form>
  </div>
</div>

<!-- Firebase Config + Script Merged in Next Update -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, getDoc, updateDoc, setDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: 'AIzaSyCoNNaQ30xVM3tjC1vBiUp6y8Hkl8sy2V8',
  authDomain: 'maynilatekdo.firebaseapp.com',
  databaseURL: 'https://maynilatekdo-default-rtdb.asia-southeast1.firebasedatabase.app',
  projectId: 'maynilatekdo',
  storageBucket: 'maynilatekdo.firebasestorage.app',
  messagingSenderId: '835673306092',
  appId: '1:835673306092:web:f0541edb14edc7741b46c9',
  measurementId: 'G-B1S4DB0T5G'
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginPanel = document.getElementById('loginPanel');
const dashboard = document.getElementById('dashboard');
const userEmail = document.getElementById('userEmail');
const roleTabs = document.getElementById('roleTabs');
const roleContent = document.getElementById('roleContent');

let role = null;

// --- Helper to hide all panels before showing the correct one ---
function hideAllPanels() {
  document.getElementById('posPanel').classList.add('hidden');
  document.getElementById('superadminPanel').classList.add('hidden');
  // You can add more panels here if needed
}

// --- Update onAuthStateChanged to hide all panels before showing dashboard ---
onAuthStateChanged(auth, async (user) => {
  if (user) {
    await addDoc(collection(db, 'attendance'), {
      uid: user.uid,
      email: user.email,
      timestamp: Timestamp.now(),
      action: 'Logged in'
    });
    const userDoc = await getDoc(doc(db, 'users', user.uid));
    if (userDoc.exists()) {
      // Hide all panels before showing dashboard
      hideAllPanels();
      // Show dashboard
      const data = userDoc.data();
      role = data.role;
      loginPanel.classList.add('hidden');
      dashboard.classList.remove('hidden');
      userEmail.textContent = `${user.email} (${role})`;
      roleTabs.innerHTML = ''; // Clear previous tabs
      roleContent.innerHTML = ''; // Clear previous content
      if (role === 'user') {
        loadEndUserTabs();
        document.getElementById('posPanel').classList.remove('hidden');
        loadUserProducts();
      }
      else if (role === 'admin') {
        loadAdminTabs();
        // Hide panels by default for admin
      }
      else if (role === 'superadmin') {
        loadSuperadminTabs();
        document.getElementById('superadminPanel').classList.remove('hidden');
        roleContent.innerHTML = '';
        loadSuperAdminProducts();
      }
    } else {
      alert('No user profile found in Firestore. Please contact admin.');
      await signOut(auth);
    }
  } else {
    // Not logged in, show login panel
    loginPanel.classList.remove('hidden');
    dashboard.classList.add('hidden');
    hideAllPanels();
  }
});

document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = loginEmail.value;
  const password = loginPassword.value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (err) {
    alert('Login failed: ' + err.message);
  }
});

document.getElementById('resetLink').addEventListener('click', async (e) => {
  e.preventDefault();
  const email = prompt("Enter your email:");
  if (email) await sendPasswordResetEmail(auth, email);
});

window.logout = () => {
  alert('You have been logged out.');
  signOut(auth);
};

// POS Submission
const form = document.getElementById('productForm');
const qrDisplay = document.getElementById('qrcode');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const product = {
    name: productName.value,
    type: productType.value,
    qty: +productQty.value,
    price: +productPrice.value,
    productDate: productDate.value,
    createdAt: Timestamp.now(),
    addedBy: auth.currentUser.uid,
    approved: false
  };
  const ref = await addDoc(collection(db, 'products'), product);
  QRCode.toCanvas(document.createElement('canvas'), JSON.stringify(product), (err, canvas) => {
    if (!err) qrDisplay.innerHTML = '', qrDisplay.appendChild(canvas);
  });
  form.reset();
  loadUserProducts();
});

async function loadUserProducts() {
  const q = query(collection(db, 'products'), where('addedBy', '==', auth.currentUser.uid));
  const snap = await getDocs(q);
  productTable.innerHTML = '';
  snap.forEach(doc => {
    const p = doc.data();
    productTable.innerHTML += `<tr class="border-b text-sm">
      <td class="p-2">${p.name}</td>
      <td class="p-2">${p.type}</td>
      <td class="p-2">${p.qty}</td>
      <td class="p-2">₱${p.price}</td>
      <td class="p-2">${p.productDate}</td>
      <td class="p-2">${p.approved ? '✅' : '⏳'}</td>
    </tr>`;
  });
}

const profileModal = document.getElementById('profileModal');
const closeProfileModal = document.getElementById('closeProfileModal');
const profileForm = document.getElementById('profileForm');

function showProfileModal() {
  profileModal.classList.remove('hidden');
  (async () => {
    const uid = auth.currentUser?.uid;
    if (!uid) return;
    const userDoc = await getDoc(doc(db, 'users', uid));
    if (userDoc.exists()) {
      const data = userDoc.data();
      document.getElementById('profileFirstName').value = data.firstName || '';
      document.getElementById('profileMiddleName').value = data.middleName || '';
      document.getElementById('profileLastName').value = data.lastName || '';
      document.getElementById('profileBirthday').value = data.birthday || '';
      document.getElementById('profileMobile').value = data.mobile || '';
      document.getElementById('profileFacebook').value = data.facebook || '';
      document.getElementById('profileInstagram').value = data.instagram || '';
      document.getElementById('profileViber').value = data.viber || '';
      document.getElementById('profileWhatsApp').value = data.whatsapp || '';
      document.getElementById('profileTikTok').value = data.tiktok || '';
      document.getElementById('profileTelegram').value = data.telegram || '';
      document.getElementById('profileBranch').value = data.branch || '';
      document.getElementById('profileAddress').value = data.address || '';
      document.getElementById('profileGender').value = data.gender || '';
      document.getElementById('profileMaritalStatus').value = data.maritalStatus || '';
      document.getElementById('profileEmail').value = data.email || auth.currentUser.email || '';
      // New fields
      document.getElementById('profileCompany').value = data.company || '';
      document.getElementById('profilePosition').value = data.position || '';
      document.getElementById('profileDepartment').value = data.department || '';
    } else {
      document.getElementById('profileEmail').value = auth.currentUser.email || '';
    }
  })();
}

closeProfileModal.onclick = () => profileModal.classList.add('hidden');
profileModal.onclick = (e) => { if (e.target === profileModal) profileModal.classList.add('hidden'); };

profileForm.onsubmit = async (e) => {
  e.preventDefault();
  const uid = auth.currentUser.uid;
  await updateDoc(doc(db, 'users', uid), {
    firstName: document.getElementById('profileFirstName').value,
    middleName: document.getElementById('profileMiddleName').value,
    lastName: document.getElementById('profileLastName').value,
    birthday: document.getElementById('profileBirthday').value,
    address: document.getElementById('profileAddress').value,
    gender: document.getElementById('profileGender').value,
    maritalStatus: document.getElementById('profileMaritalStatus').value,
    email: document.getElementById('profileEmail').value,
    mobile: document.getElementById('profileMobile').value,
    facebook: document.getElementById('profileFacebook').value,
    instagram: document.getElementById('profileInstagram').value,
    viber: document.getElementById('profileViber').value,
    whatsapp: document.getElementById('profileWhatsApp').value,
    tiktok: document.getElementById('profileTikTok').value,
    telegram: document.getElementById('profileTelegram').value,
    branch: document.getElementById('profileBranch').value,
    // New fields
    company: document.getElementById('profileCompany').value,
    position: document.getElementById('profilePosition').value,
    department: document.getElementById('profileDepartment').value
  });
  const newPassword = document.getElementById('profilePassword').value;
  if (newPassword) {
    try {
      await auth.currentUser.updatePassword(newPassword);
      alert('Password updated.');
    } catch (err) {
      alert('Password update failed: ' + err.message);
    }
  }
  alert('Profile updated.');
  profileModal.classList.add('hidden');
};

function loadEndUserTabs() {
  // POS Button
  const btn = document.createElement('button');
  btn.textContent = 'POS';
  btn.className = 'px-4 py-2 bg-blue-100 rounded';
  btn.onclick = () => {
    roleContent.innerHTML = '';
    document.getElementById('posPanel').classList.remove('hidden');
    loadUserProducts();
  };
  roleTabs.appendChild(btn);

  // My Sold Products
  const soldBtn = document.createElement('button');
  soldBtn.textContent = 'My Sold Products';
  soldBtn.className = 'px-4 py-2 bg-green-100 rounded';
  soldBtn.onclick = async () => {
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">My Sold Products</h2>';
    const q = query(collection(db, 'products'), where('addedBy', '==', auth.currentUser.uid), where('approved', '==', true));
    const snap = await getDocs(q);
    const table = document.createElement('table');
    table.className = 'w-full bg-white rounded shadow text-sm';
    table.innerHTML = `<thead class='bg-gray-100'>
      <tr>
        <th class='p-2'>Name</th>
        <th class='p-2'>Type</th>
        <th class='p-2'>Qty</th>
        <th class='p-2'>Price</th>
        <th class='p-2'>Date</th>
      </tr>
    </thead>
    <tbody></tbody>`;
    const body = table.querySelector('tbody');
    snap.forEach(doc => {
      const p = doc.data();
      body.innerHTML += `<tr class="border-b">
        <td class="p-2">${p.name}</td>
        <td class="p-2">${p.type}</td>
        <td class="p-2">${p.qty}</td>
        <td class="p-2">₱${p.price}</td>
        <td class="p-2">${p.productDate}</td>
      </tr>`;
    });
    roleContent.appendChild(table);
  };
  roleTabs.appendChild(soldBtn);

  // My Inventory (all products added by user, regardless of approval)
  const inventoryBtn = document.createElement('button');
  inventoryBtn.textContent = 'My Inventory';
  inventoryBtn.className = 'px-4 py-2 bg-yellow-100 rounded';
  inventoryBtn.onclick = async () => {
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">My Inventory</h2>';
    const q = query(collection(db, 'products'), where('addedBy', '==', auth.currentUser.uid));
    const snap = await getDocs(q);
    const table = document.createElement('table');
    table.className = 'w-full bg-white rounded shadow text-sm';
    table.innerHTML = `<thead class='bg-gray-100'>
      <tr>
        <th class='p-2'>Name</th>
        <th class='p-2'>Type</th>
        <th class='p-2'>Qty</th>
        <th class='p-2'>Price</th>
        <th class='p-2'>Date</th>
        <th class='p-2'>Status</th>
      </tr>
    </thead>
    <tbody></tbody>`;
    const body = table.querySelector('tbody');
    snap.forEach(doc => {
      const p = doc.data();
      body.innerHTML += `<tr class="border-b">
        <td class="p-2">${p.name}</td>
        <td class="p-2">${p.type}</td>
        <td class="p-2">${p.qty}</td>
        <td class="p-2">₱${p.price}</td>
        <td class="p-2">${p.productDate}</td>
        <td class="p-2">${p.approved ? '✅' : '⏳'}</td>
      </tr>`;
    });
    roleContent.appendChild(table);
  };
  roleTabs.appendChild(inventoryBtn);

  // My Profile as modal
  const profileBtn = document.createElement('button');
  profileBtn.textContent = 'My Profile';
  profileBtn.className = 'px-4 py-2 bg-blue-100 rounded';
  profileBtn.onclick = showProfileModal;
  roleTabs.appendChild(profileBtn);
}

function loadAdminTabs() {
  const attendanceBtn = document.createElement('button');
  attendanceBtn.textContent = 'Attendance Logs';
  attendanceBtn.className = 'px-4 py-2 bg-green-100 rounded';
  attendanceBtn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden');
    document.getElementById('superadminPanel').classList.add('hidden');
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">User Attendance Logs</h2>';
    const snap = await getDocs(query(collection(db, 'attendance'), orderBy('timestamp', 'desc')));
    const usersSnap = await getDocs(collection(db, 'users'));
    const userRoles = {};
    usersSnap.forEach(doc => {
      userRoles[doc.id] = doc.data().role;
    });

    const table = document.createElement('table');
    table.className = 'w-full bg-white rounded shadow text-sm';
    table.innerHTML = `<thead class='bg-gray-100'>
      <tr>
        <th class='p-2'>User</th>
        <th class='p-2'>Date</th>
        <th class='p-2'>Time</th>
        <th class='p-2'>Action</th>
      </tr>
    </thead>
    <tbody id='attendanceTable'></tbody>`;
    const body = table.querySelector('tbody');
    snap.forEach(doc => {
      const a = doc.data();
      const d = a.timestamp.toDate();
      const role = userRoles[a.uid] || '';
      // Only show if role is 'user' or 'admin'
      if (role === 'user' || role === 'admin') {
        body.innerHTML += `<tr class='border-b'>
          <td class='p-2'>${a.email} (${role})</td>
          <td class='p-2'>${d.toLocaleDateString()}</td>
          <td class='p-2'>${d.toLocaleTimeString()}</td>
          <td class='p-2'>${a.action || ''}</td>
        </tr>`;
      }
    });
    // Export CSV Button
    const exportBtn = document.createElement('button');
    exportBtn.textContent = 'Export CSV';
    exportBtn.className = 'mt-4 px-4 py-2 bg-green-600 text-white rounded';
    exportBtn.onclick = () => {
      const rows = [['Email', 'Date', 'Time', 'Action']];
      snap.forEach(doc => {
        const a = doc.data();
        const d = a.timestamp.toDate();
        const role = userRoles[a.uid];
        if (role === 'user' || role === 'admin') {
          rows.push([
            a.email + ' (' + (role || '') + ')',
            d.toLocaleDateString(),
            d.toLocaleTimeString(),
            a.action || ''
          ]);
        }
      });
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'attendance_logs.csv';
      link.click();
    };
    roleContent.appendChild(table);
    roleContent.appendChild(exportBtn);

    // Chart (optional, filtered)
    const chartCanvas = document.createElement('canvas');
    chartCanvas.id = 'attendanceChart';
    chartCanvas.className = 'my-6';
    roleContent.appendChild(chartCanvas);

    const counts = {};
    snap.forEach(doc => {
      const a = doc.data();
      const d = a.timestamp.toDate();
      const role = userRoles[a.uid];
      if (role === 'user' || role === 'admin') {
        const dateStr = d.toLocaleDateString();
        counts[dateStr] = (counts[dateStr] || 0) + 1;
      }
    });
    new Chart(chartCanvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: 'Logins per Day',
          data: Object.values(counts),
          backgroundColor: 'rgba(59, 130, 246, 0.2)',
          borderColor: 'rgba(59, 130, 246, 1)',
          borderWidth: 2,
          fill: true
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  };
  roleTabs.appendChild(attendanceBtn);
  const btn = document.createElement('button');
  btn.textContent = 'Approve Products';
  btn.className = 'px-4 py-2 bg-yellow-200 rounded';
  btn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden');
    document.getElementById('superadminPanel').classList.add('hidden');
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">Pending Products</h2>';
    const table = document.createElement('table');
    table.className = 'w-full text-sm';
    const q = query(collection(db, 'products'), where('approved', '==', false));
    const snap = await getDocs(q);
    snap.forEach(docSnap => {
      const p = docSnap.data();
      const row = `<tr class="border-b">
        <td class="p-2">${p.name}</td>
        <td class="p-2">${p.productDate}</td>
        <td class="p-2"><button onclick="approveProduct('${docSnap.id}')" class="bg-green-600 text-white px-2 py-1 rounded">Approve</button></td>
      </tr>`;
      table.innerHTML += row;
    });
    roleContent.appendChild(table);
  };
  roleTabs.appendChild(btn);

  // My Profile as modal
  const profileBtn = document.createElement('button');
  profileBtn.textContent = 'My Profile';
  profileBtn.className = 'px-4 py-2 bg-yellow-100 rounded';
  profileBtn.onclick = showProfileModal;
  roleTabs.appendChild(profileBtn);

  // Manage Users
  const manageBtn = document.createElement('button');
  manageBtn.textContent = 'Manage Users';
  manageBtn.className = 'px-4 py-2 bg-red-100 rounded';
  manageBtn.onclick = async () => {
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">User Management</h2>';
    const snap = await getDocs(query(collection(db, 'users'), where('role', '==', 'user')));
    const table = document.createElement('table');
    table.className = 'w-full bg-white rounded shadow text-sm mb-4';
    table.innerHTML = `<thead class='bg-gray-100'>
      <tr>
        <th class='p-2'>Email</th>
        <th class='p-2'>Role</th>
        <th class='p-2'>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>`;
    const body = table.querySelector('tbody');
    snap.forEach(doc => {
      const u = doc.data();
      body.innerHTML += `<tr class="border-b">
        <td class="p-2">${u.email}</td>
        <td class="p-2">${u.role}</td>
        <td class="p-2">
          <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="editUser('${doc.id}', '${u.email}', '${u.role}')">Edit</button>
          <button class="bg-red-600 text-white px-2 py-1 rounded" onclick="deleteUser('${doc.id}')">Delete</button>
        </td>
      </tr>`;
    });
    roleContent.appendChild(table);

    // Add User Form
    const form = document.createElement('form');
    form.className = 'space-y-2';
    form.innerHTML = `
      <input type="email" id="newUserEmail" placeholder="Email" class="border p-2 rounded w-1/3" required />
      <input type="password" id="newUserPassword" placeholder="Password" class="border p-2 rounded w-1/3" required />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Add</button>
    `;
    form.onsubmit = async (e) => {
      e.preventDefault();
      const email = form.querySelector('#newUserEmail').value;
      const password = form.querySelector('#newUserPassword').value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', cred.user.uid), { email, role: 'user' });
        alert('User created!');
        manageBtn.onclick(); // reload
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };
    roleContent.appendChild(form);
  };
  roleTabs.appendChild(manageBtn);
}

function loadSuperadminTabs() {
  // Attendance Logs Button
  const attendanceBtn = document.createElement('button');
  attendanceBtn.textContent = 'Attendance Logs';
  attendanceBtn.className = 'px-4 py-2 bg-green-100 rounded';
  attendanceBtn.onclick = async () => {
    document.getElementById('posPanel').classList.add('hidden');
    document.getElementById('superadminPanel').classList.add('hidden');
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">User Attendance Logs</h2>';
    const snap = await getDocs(query(collection(db, 'attendance'), orderBy('timestamp', 'desc')));
    const usersSnap = await getDocs(collection(db, 'users'));
    const userRoles = {};
    usersSnap.forEach(doc => {
      userRoles[doc.id] = doc.data().role;
    });

    const table = document.createElement('table');
    table.className = 'w-full bg-white rounded shadow text-sm';
    table.innerHTML = `<thead class='bg-gray-100'>
      <tr>
        <th class='p-2'>User</th>
        <th class='p-2'>Date</th>
        <th class='p-2'>Time</th>
        <th class='p-2'>Action</th>
      </tr>
    </thead>
    <tbody id='attendanceTable'></tbody>`;
    const body = table.querySelector('tbody');
    snap.forEach(doc => {
      const a = doc.data();
      const d = a.timestamp.toDate();
      const role = userRoles[a.uid] || '';
      body.innerHTML += `<tr class='border-b'>
        <td class='p-2'>${a.email} (${role})</td>
        <td class='p-2'>${d.toLocaleDateString()}</td>
        <td class='p-2'>${d.toLocaleTimeString()}</td>
        <td class='p-2'>${a.action || ''}</td>
      </tr>`;
    });
    // Export CSV Button
    const exportBtn = document.createElement('button');
    exportBtn.textContent = 'Export CSV';
    exportBtn.className = 'mt-4 px-4 py-2 bg-green-600 text-white rounded';
    exportBtn.onclick = () => {
      const rows = [['Email', 'Date', 'Time', 'Action']];
      snap.forEach(doc => {
        const a = doc.data();
        const d = a.timestamp.toDate();
        const role = userRoles[a.uid];
        rows.push([
          a.email + ' (' + (role || '') + ')',
          d.toLocaleDateString(),
          d.toLocaleTimeString(),
          a.action || ''
        ]);
      });
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'attendance_logs.csv';
      link.click();
    };
    roleContent.appendChild(table);
    roleContent.appendChild(exportBtn);
  };
  roleTabs.appendChild(attendanceBtn);

  // All Products Button
  const btn = document.createElement('button');
  btn.textContent = 'All Products';
  btn.className = 'px-4 py-2 bg-purple-100 rounded';
  btn.onclick = () => {
    document.getElementById('posPanel').classList.add('hidden');
    document.getElementById('superadminPanel').classList.remove('hidden');
    roleContent.innerHTML = '';
    loadSuperAdminProducts();
  };
  roleTabs.appendChild(btn);

  // My Profile as modal
  const profileBtn = document.createElement('button');
  profileBtn.textContent = 'My Profile';
  profileBtn.className = 'px-4 py-2 bg-purple-200 rounded';
  profileBtn.onclick = showProfileModal;
  roleTabs.appendChild(profileBtn);

  // Manage Users/Admins
  const manageBtn = document.createElement('button');
  manageBtn.textContent = 'Manage Users/Admins';
  manageBtn.className = 'px-4 py-2 bg-red-100 rounded';
  manageBtn.onclick = async () => {
    roleContent.innerHTML = '<h2 class="text-lg font-bold mb-4">User & Admin Management</h2>';
    const snap = await getDocs(query(collection(db, 'users'), where('role', 'in', ['user', 'admin'])));
    const table = document.createElement('table');
    table.className = 'w-full bg-white rounded shadow text-sm mb-4';
    table.innerHTML = `<thead class='bg-gray-100'>
      <tr>
        <th class='p-2'>Email</th>
        <th class='p-2'>Role</th>
        <th class='p-2'>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>`;
    const body = table.querySelector('tbody');
    snap.forEach(doc => {
      const u = doc.data();
      body.innerHTML += `<tr class="border-b">
        <td class="p-2">${u.email}</td>
        <td class="p-2">${u.role}</td>
        <td class="p-2">
          <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="editUser('${doc.id}', '${u.email}', '${u.role}')">Edit</button>
          <button class="bg-red-600 text-white px-2 py-1 rounded" onclick="deleteUser('${doc.id}')">Delete</button>
        </td>
      </tr>`;
    });
    roleContent.appendChild(table);

    // Add User/Admin Form
    const form = document.createElement('form');
    form.className = 'space-y-2';
    form.innerHTML = `
      <input type="email" id="newUserEmail" placeholder="Email" class="border p-2 rounded w-1/3" required />
      <input type="password" id="newUserPassword" placeholder="Password" class="border p-2 rounded w-1/3" required />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Add</button>
    `;
    form.onsubmit = async (e) => {
      e.preventDefault();
      const email = form.querySelector('#newUserEmail').value;
      const password = form.querySelector('#newUserPassword').value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', cred.user.uid), { email, role: 'user' });
        alert('User created!');
        manageBtn.onclick(); // reload
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };
    roleContent.appendChild(form);
  };
  roleTabs.appendChild(manageBtn);
}


const exportCsvBtn = document.getElementById('exportCsvBtn');
const filterBranch = document.getElementById('filterBranch');
const filterType = document.getElementById('filterType');
const superadminTable = document.getElementById('superadminTable');
const totalValuation = document.getElementById('totalValuation');

let cachedData = [];

async function loadSuperAdminProducts() {
  const snap = await getDocs(query(collection(db, 'products')));
  const branchFilter = filterBranch.value.toLowerCase();
  const typeFilter = filterType.value;
  superadminTable.innerHTML = '';
  cachedData = [];
  const productMap = new Map();
  let total = 0;

  snap.forEach(docSnap => {
    const p = docSnap.data();
    const matchesBranch = !branchFilter || (p.branch || '').toLowerCase().includes(branchFilter);
    const matchesType = !typeFilter || p.type === typeFilter;
    if (!matchesBranch || !matchesType) return;
    cachedData.push(p);
    total += (p.qty * p.price);
    const row = `<tr class="border-b text-sm">
      <td class="p-2">${p.name}</td>
      <td class="p-2">${p.type}</td>
      <td class="p-2">${p.qty}</td>
      <td class="p-2">₱${p.price}</td>
      <td class="p-2">${p.productDate}</td>
      <td class="p-2">${p.addedBy || ''}</td>
      <td class="p-2">${p.qty < 10 ? 'Low Stock' : ''}</td>
    </tr>`;
    superadminTable.innerHTML += row;
    const sum = (productMap.get(p.name) || 0) + p.qty;
    productMap.set(p.name, sum);
  });
  totalValuation.textContent = `Total Inventory Value: ₱${total.toLocaleString()}`;
  renderChart(productMap);
}

function renderChart(dataMap) {
  const ctx = document.getElementById('topProductsChart').getContext('2d');
  const sorted = [...dataMap.entries()].sort((a, b) => b[1] - a[1]).slice(0, 10);
  const labels = sorted.map(x => x[0]);
  const values = sorted.map(x => x[1]);
  if (window.topProductsChartInstance) window.topProductsChartInstance.destroy();
  window.topProductsChartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Top Products', data: values, backgroundColor: '#3b82f6' }] },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}

filterBranch.addEventListener('input', loadSuperAdminProducts);
filterType.addEventListener('change', loadSuperAdminProducts);


exportCsvBtn.addEventListener('click', () => {
  const rows = [['Name','Type','Qty','Price','Date','Added By','Alert']];
  cachedData.forEach(p => rows.push([p.name, p.type, p.qty, p.price, p.productDate, p.addedBy || '', p.qty < 10 ? 'Low Stock' : '']));
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'all_products_report.csv';
  link.click();
});

async function approveProduct(productId) {
  const productRef = doc(db, 'products', productId);
  await updateDoc(productRef, { approved: true });
  alert('Product approved!');
  // Optionally reload the product list
  if (typeof loadSuperAdminProducts === 'function') loadSuperAdminProducts();
}
window.approveProduct = approveProduct; // Make it accessible from HTML

// --- Add these helper functions globally ---
window.editUser = async (id, email, role) => {
  const newRole = prompt(`Edit role for ${email}:`, role);
  if (!newRole || (role === 'admin' && newRole === 'superadmin')) return;
  await updateDoc(doc(db, 'users', id), { role: newRole });
  alert('Role updated.');
  // Reload the management tab
  if (window.role === 'superadmin') document.querySelector('button:contains("Manage Users/Admins")').click();
  else document.querySelector('button:contains("Manage Users")').click();
};

window.deleteUser = async (id) => {
  if (!confirm('Are you sure you want to delete this user?')) return;
  await deleteDoc(doc(db, 'users', id));
  alert('User deleted.');
  // Reload the management tab
  if (window.role === 'superadmin') document.querySelector('button:contains("Manage Users/Admins")').click();
  else document.querySelector('button:contains("Manage Users")').click();
};

const addBtn = document.createElement('button');
addBtn.textContent = 'Add User/Admin';
addBtn.className = 'bg-blue-600 text-white px-4 py-2 rounded mb-4';
addBtn.onclick = () => {
  document.getElementById('addUserModal').classList.remove('hidden');
  // If admin, hide admin option
  if (role === 'admin') document.getElementById('modalUserRole').style.display = 'none';
  else document.getElementById('modalUserRole').style.display = '';
};
roleContent.appendChild(addBtn);

// Modal logic
const addUserModal = document.getElementById('addUserModal');
const closeAddUserModal = document.getElementById('closeAddUserModal');
closeAddUserModal.onclick = () => addUserModal.classList.add('hidden');
addUserModal.onclick = (e) => { if (e.target === addUserModal) addUserModal.classList.add('hidden'); };

document.getElementById('addUserForm').onsubmit = async (e) => {
  e.preventDefault();
  const email = document.getElementById('modalUserEmail').value;
  const password = document.getElementById('modalUserPassword').value;
  const roleValue = document.getElementById('modalUserRole').value || 'user';
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(db, 'users', cred.user.uid), { email, role: roleValue });
    alert('User created!');
    addUserModal.classList.add('hidden');
    // Optionally reload the management tab
    if (window.role === 'superadmin') document.querySelector('button:contains("Manage Users/Admins")').click();
    else document.querySelector('button:contains("Manage Users")').click();
  } catch (err) {
    alert('Error: ' + err.message);
  }
};
</script>
</body>
</html>
